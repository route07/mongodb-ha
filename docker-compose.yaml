#version: '3.8'
# High Availability MongoDB Replica Set Configuration

services:
  # MongoDB Primary Node
  mongodb-primary:
    image: mongo:7.0
    container_name: mongo-primary
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - ./db_data_primary:/data/db
      - ./tls-certs:/etc/mongo/ssl:ro
      - ./scripts:/scripts:ro
    entrypoint: ["bash", "/scripts/fix-keyfile-permissions.sh"]
    command: >
      mongod
      --replSet ${REPLICA_SET_NAME:-rs0}
      --keyFile /etc/mongo/ssl/keyfile
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/mongo/ssl/server.pem
      --tlsCAFile /etc/mongo/ssl/ca.crt
      --tlsAllowConnectionsWithoutCertificates
      --bind_ip_all
    networks:
      - db-network
    healthcheck:
      test: ["CMD", "bash", "/scripts/healthcheck.sh"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # MongoDB Secondary Node 1
  mongodb-secondary-1:
    image: mongo:7.0
    container_name: mongo-secondary-1
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - ./db_data_secondary1:/data/db
      - ./tls-certs:/etc/mongo/ssl:ro
      - ./scripts:/scripts:ro
    entrypoint: ["bash", "/scripts/fix-keyfile-permissions.sh"]
    command: >
      mongod
      --replSet ${REPLICA_SET_NAME:-rs0}
      --keyFile /etc/mongo/ssl/keyfile
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/mongo/ssl/server.pem
      --tlsCAFile /etc/mongo/ssl/ca.crt
      --tlsAllowConnectionsWithoutCertificates
      --bind_ip_all
    networks:
      - db-network
    healthcheck:
      test: ["CMD", "bash", "/scripts/healthcheck.sh"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      mongodb-primary:
        condition: service_healthy

  # MongoDB Secondary Node 2
  mongodb-secondary-2:
    image: mongo:7.0
    container_name: mongo-secondary-2
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - ./db_data_secondary2:/data/db
      - ./tls-certs:/etc/mongo/ssl:ro
      - ./scripts:/scripts:ro
    entrypoint: ["bash", "/scripts/fix-keyfile-permissions.sh"]
    command: >
      mongod
      --replSet ${REPLICA_SET_NAME:-rs0}
      --keyFile /etc/mongo/ssl/keyfile
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/mongo/ssl/server.pem
      --tlsCAFile /etc/mongo/ssl/ca.crt
      --tlsAllowConnectionsWithoutCertificates
      --bind_ip_all
    networks:
      - db-network
    healthcheck:
      test: ["CMD", "bash", "/scripts/healthcheck.sh"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      mongodb-primary:
        condition: service_healthy

  # Ensure root user exists (runs after primary is up)
  # This container is idempotent - exits immediately if user already exists
  mongodb-init-user:
    image: mongo:7.0
    container_name: mongo-init-user
    restart: "no"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    volumes:
      - ./tls-certs:/etc/mongo/ssl:ro
      - ./scripts:/scripts:ro
    entrypoint: ["bash", "/scripts/init-user.sh"]
    command: ["mongodb-primary", "27017"]
    networks:
      - db-network
    depends_on:
      mongodb-primary:
        condition: service_started

  # Replica Set Initialization Service
  # This container is idempotent - exits immediately if replica set already initialized
  mongodb-init:
    image: mongo:7.0
    container_name: mongo-init
    restart: "no"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      REPLICA_SET_NAME: ${REPLICA_SET_NAME:-rs0}
    volumes:
      - ./tls-certs:/etc/mongo/ssl:ro
      - ./scripts:/scripts:ro
    entrypoint: ["bash", "/scripts/init-replica-set.sh"]
    networks:
      - db-network
    depends_on:
      mongodb-primary:
        condition: service_healthy
      mongodb-secondary-1:
        condition: service_healthy
      mongodb-secondary-2:
        condition: service_healthy
      mongodb-init-user:
        condition: service_completed_successfully

  ## Custom MongoDB Admin UI (with TLS and Replica Set support)
  mongo-admin:
    build: ./mongo-admin
    container_name: mongo-admin
    restart: unless-stopped
    ports:
      - "${ADMIN_UI_PORT:-3000}:3000"
    environment:
      MONGO_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_HOST: mongodb-primary
      MONGO_PORT: ${MONGO_PORT:-27017}
      MONGO_REPLICA_SET: ${REPLICA_SET_NAME:-rs0}
      MONGO_TLS: "true"
      MONGO_TLS_ALLOW_INVALID: "true"
      MONGO_TLS_CA_FILE: /etc/mongo/ssl/ca.crt
      MONGO_TLS_CLIENT_CERT_FILE: /etc/mongo/ssl/client.pem
      ADMIN_UI_PORT: 3000
      WEB3_AUTH_ENABLED: ${WEB3_AUTH_ENABLED:-false}
      ADMIN_WALLETS: ${ADMIN_WALLETS:-}
      SESSION_SECRET: ${SESSION_SECRET:-mongo-admin-secret-change-in-production}
    volumes:
      - ./tls-certs:/etc/mongo/ssl:ro
    depends_on:
      mongodb-primary:
        condition: service_healthy
      mongodb-secondary-1:
        condition: service_healthy
      mongodb-secondary-2:
        condition: service_healthy
      # Init containers: use service_started to allow mongo-admin to start
      # even if init containers fail (they'll exit gracefully if user can't be created)
      mongodb-init:
        condition: service_started
      mongodb-init-user:
        condition: service_started
    networks:
      - db-network

networks:
  db-network:
    driver: bridge
